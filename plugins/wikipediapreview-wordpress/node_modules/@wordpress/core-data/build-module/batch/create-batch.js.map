{"version":3,"sources":["@wordpress/core-data/src/batch/create-batch.js"],"names":["isFunction","zip","defaultProcessor","createBatch","processor","lastId","queue","pending","ObservableSet","add","inputOrThunk","id","input","Promise","resolve","reject","push","delete","finally","run","size","unsubscribe","subscribe","results","map","length","Error","error","isSuccess","result","output","constructor","args","set","Set","subscribers","forEach","subscriber"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { isFunction, zip } from 'lodash';\n\n/**\n * Internal dependencies\n */\nimport defaultProcessor from './default-processor';\n\n/**\n * Creates a batch, which can be used to combine multiple API requests into one\n * API request using the WordPress batch processing API (/v1/batch).\n *\n * ```\n * const batch = createBatch();\n * const dunePromise = batch.add( {\n *   path: '/v1/books',\n *   method: 'POST',\n *   data: { title: 'Dune' }\n * } );\n * const lotrPromise = batch.add( {\n *   path: '/v1/books',\n *   method: 'POST',\n *   data: { title: 'Lord of the Rings' }\n * } );\n * const isSuccess = await batch.run(); // Sends one POST to /v1/batch.\n * if ( isSuccess ) {\n *   console.log(\n *     'Saved two books:',\n *     await dunePromise,\n *     await lotrPromise\n *   );\n * }\n * ```\n *\n * @param {Function} [processor] Processor function. Can be used to replace the\n *                               default functionality which is to send an API\n *                               request to /v1/batch. Is given an array of\n *                               inputs and must return a promise that\n *                               resolves to an array of objects containing\n *                               either `output` or `error`.\n */\nexport default function createBatch( processor = defaultProcessor ) {\n\tlet lastId = 0;\n\tlet queue = [];\n\tconst pending = new ObservableSet();\n\n\treturn {\n\t\t/**\n\t\t * Adds an input to the batch and returns a promise that is resolved or\n\t\t * rejected when the input is processed by `batch.run()`.\n\t\t *\n\t\t * You may also pass a thunk which allows inputs to be added\n\t\t * asychronously.\n\t\t *\n\t\t * ```\n\t\t * // Both are allowed:\n\t\t * batch.add( { path: '/v1/books', ... } );\n\t\t * batch.add( ( add ) => add( { path: '/v1/books', ... } ) );\n\t\t * ```\n\t\t *\n\t\t * If a thunk is passed, `batch.run()` will pause until either:\n\t\t *\n\t\t * - The thunk calls its `add` argument, or;\n\t\t * - The thunk returns a promise and that promise resolves, or;\n\t\t * - The thunk returns a non-promise.\n\t\t *\n\t\t * @param {any|Function} inputOrThunk Input to add or thunk to execute.\n\t\t *\n\t\t * @return {Promise|any} If given an input, returns a promise that\n\t\t *                       is resolved or rejected when the batch is\n\t\t *                       processed. If given a thunk, returns the return\n\t\t *                       value of that thunk.\n\t\t */\n\t\tadd( inputOrThunk ) {\n\t\t\tconst id = ++lastId;\n\t\t\tpending.add( id );\n\n\t\t\tconst add = ( input ) =>\n\t\t\t\tnew Promise( ( resolve, reject ) => {\n\t\t\t\t\tqueue.push( {\n\t\t\t\t\t\tinput,\n\t\t\t\t\t\tresolve,\n\t\t\t\t\t\treject,\n\t\t\t\t\t} );\n\t\t\t\t\tpending.delete( id );\n\t\t\t\t} );\n\n\t\t\tif ( isFunction( inputOrThunk ) ) {\n\t\t\t\treturn Promise.resolve( inputOrThunk( add ) ).finally( () => {\n\t\t\t\t\tpending.delete( id );\n\t\t\t\t} );\n\t\t\t}\n\n\t\t\treturn add( inputOrThunk );\n\t\t},\n\n\t\t/**\n\t\t * Runs the batch. This calls `batchProcessor` and resolves or rejects\n\t\t * all promises returned by `add()`.\n\t\t *\n\t\t * @return {Promise} A promise that resolves to a boolean that is true\n\t\t *                   if the processor returned no errors.\n\t\t */\n\t\tasync run() {\n\t\t\tif ( pending.size ) {\n\t\t\t\tawait new Promise( ( resolve ) => {\n\t\t\t\t\tconst unsubscribe = pending.subscribe( () => {\n\t\t\t\t\t\tif ( ! pending.size ) {\n\t\t\t\t\t\t\tunsubscribe();\n\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t}\n\t\t\t\t\t} );\n\t\t\t\t} );\n\t\t\t}\n\n\t\t\tlet results;\n\n\t\t\ttry {\n\t\t\t\tresults = await processor(\n\t\t\t\t\tqueue.map( ( { input } ) => input )\n\t\t\t\t);\n\n\t\t\t\tif ( results.length !== queue.length ) {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t'run: Array returned by processor must be same size as input array.'\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t} catch ( error ) {\n\t\t\t\tfor ( const { reject } of queue ) {\n\t\t\t\t\treject( error );\n\t\t\t\t}\n\n\t\t\t\tthrow error;\n\t\t\t}\n\n\t\t\tlet isSuccess = true;\n\n\t\t\tfor ( const [ result, { resolve, reject } ] of zip(\n\t\t\t\tresults,\n\t\t\t\tqueue\n\t\t\t) ) {\n\t\t\t\tif ( result?.error ) {\n\t\t\t\t\treject( result.error );\n\t\t\t\t\tisSuccess = false;\n\t\t\t\t} else {\n\t\t\t\t\tresolve( result?.output ?? result );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tqueue = [];\n\n\t\t\treturn isSuccess;\n\t\t},\n\t};\n}\n\nclass ObservableSet {\n\tconstructor( ...args ) {\n\t\tthis.set = new Set( ...args );\n\t\tthis.subscribers = new Set();\n\t}\n\n\tget size() {\n\t\treturn this.set.size;\n\t}\n\n\tadd( ...args ) {\n\t\tthis.set.add( ...args );\n\t\tthis.subscribers.forEach( ( subscriber ) => subscriber() );\n\t\treturn this;\n\t}\n\n\tdelete( ...args ) {\n\t\tconst isSuccess = this.set.delete( ...args );\n\t\tthis.subscribers.forEach( ( subscriber ) => subscriber() );\n\t\treturn isSuccess;\n\t}\n\n\tsubscribe( subscriber ) {\n\t\tthis.subscribers.add( subscriber );\n\t\treturn () => {\n\t\t\tthis.subscribers.delete( subscriber );\n\t\t};\n\t}\n}\n"]}