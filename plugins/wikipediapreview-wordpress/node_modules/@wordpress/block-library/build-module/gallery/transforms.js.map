{"version":3,"sources":["@wordpress/block-library/src/gallery/transforms.js"],"names":["filter","every","toString","createBlock","createBlobURL","select","store","blockEditorStore","addFilter","LINK_DESTINATION_ATTACHMENT","LINK_DESTINATION_NONE","LINK_DESTINATION_MEDIA","DEPRECATED_LINK_DESTINATION_ATTACHMENT","DEPRECATED_LINK_DESTINATION_MEDIA","pickRelevantMediaFiles","parseShortcodeIds","ids","split","map","id","parseInt","updateThirdPartyTransformToGallery","block","settings","getSettings","__unstableGalleryWithImageBlocks","name","attributes","images","length","innerBlocks","url","alt","sizeSlug","linkDestination","updateThirdPartyTransformFromGallery","toBlock","fromBlocks","from","Array","isArray","galleryBlock","find","transformedBlock","includes","transforms","type","isMultiBlock","blocks","transform","align","undefined","validImages","image","caption","tag","shortcode","named","shortCodeTransforms","columns","linkTo","link","isMatch","priority","files","file","indexOf","to","imageSizeSlug","index"],"mappings":"AAAA;AACA;AACA;AACA,SAASA,MAAT,EAAiBC,KAAjB,EAAwBC,QAAxB,QAAwC,QAAxC;AAEA;AACA;AACA;;AACA,SAASC,WAAT,QAA4B,mBAA5B;AACA,SAASC,aAAT,QAA8B,iBAA9B;AACA,SAASC,MAAT,QAAuB,iBAAvB;AACA,SAASC,KAAK,IAAIC,gBAAlB,QAA0C,yBAA1C;AACA,SAASC,SAAT,QAA0B,kBAA1B;AAEA;AACA;AACA;;AACA,SACCC,2BADD,EAECC,qBAFD,EAGCC,sBAHD,QAIO,aAJP;AAKA,SACCF,2BAA2B,IAAIG,sCADhC,EAECD,sBAAsB,IAAIE,iCAF3B,QAGO,gBAHP;AAIA,SAASC,sBAAT,QAAuC,UAAvC;;AAEA,MAAMC,iBAAiB,GAAKC,GAAF,IAAW;AACpC,MAAK,CAAEA,GAAP,EAAa;AACZ,WAAO,EAAP;AACA;;AAED,SAAOA,GAAG,CAACC,KAAJ,CAAW,GAAX,EAAiBC,GAAjB,CAAwBC,EAAF,IAAUC,QAAQ,CAAED,EAAF,EAAM,EAAN,CAAxC,CAAP;AACA,CAND;AAQA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,SAASE,kCAAT,CAA6CC,KAA7C,EAAqD;AAAA;;AACpD,QAAMC,QAAQ,GAAGlB,MAAM,CAAEE,gBAAF,CAAN,CAA2BiB,WAA3B,EAAjB;;AACA,MACCD,QAAQ,CAACE,gCAAT,IACAH,KAAK,CAACI,IAAN,KAAe,cADf,IAEA,sBAAAJ,KAAK,CAACK,UAAN,wEAAkBC,MAAlB,CAAyBC,MAAzB,IAAkC,CAHnC,EAIE;AACD,UAAMC,WAAW,GAAGR,KAAK,CAACK,UAAN,CAAiBC,MAAjB,CAAwBV,GAAxB,CACnB,CAAE;AAAEa,MAAAA,GAAF;AAAOZ,MAAAA,EAAP;AAAWa,MAAAA;AAAX,KAAF,KAAwB;AACvB,aAAO7B,WAAW,CAAE,YAAF,EAAgB;AACjC4B,QAAAA,GADiC;AAEjCZ,QAAAA,EAAE,EAAEA,EAAE,GAAGC,QAAQ,CAAED,EAAF,EAAM,EAAN,CAAX,GAAwB,IAFG;AAGjCa,QAAAA,GAHiC;AAIjCC,QAAAA,QAAQ,EAAEX,KAAK,CAACK,UAAN,CAAiBM,QAJM;AAKjCC,QAAAA,eAAe,EAAEZ,KAAK,CAACK,UAAN,CAAiBO;AALD,OAAhB,CAAlB;AAOA,KATkB,CAApB;AAYA,WAAOZ,KAAK,CAACK,UAAN,CAAiBX,GAAxB;AACA,WAAOM,KAAK,CAACK,UAAN,CAAiBC,MAAxB;AACAN,IAAAA,KAAK,CAACQ,WAAN,GAAoBA,WAApB;AACA;;AAED,SAAOR,KAAP;AACA;;AACDd,SAAS,CACR,2CADQ,EAER,8CAFQ,EAGRa,kCAHQ,CAAT;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,SAASc,oCAAT,CAA+CC,OAA/C,EAAwDC,UAAxD,EAAqE;AACpE,QAAMC,IAAI,GAAGC,KAAK,CAACC,OAAN,CAAeH,UAAf,IAA8BA,UAA9B,GAA2C,CAAEA,UAAF,CAAxD;AACA,QAAMI,YAAY,GAAGH,IAAI,CAACI,IAAL,CAClBC,gBAAF;AAAA;;AAAA,WACCA,gBAAgB,CAACjB,IAAjB,KAA0B,cAA1B,IACAiB,gBAAgB,CAACb,WAAjB,CAA6BD,MAA7B,GAAsC,CADtC,IAEA,2BAAEc,gBAAgB,CAAChB,UAAjB,CAA4BC,MAA9B,kDAAE,sBAAoCC,MAAtC,IAA+C,CAF/C,IAGA,CAAEO,OAAO,CAACV,IAAR,CAAakB,QAAb,CAAuB,OAAvB,CAJH;AAAA,GADoB,CAArB;;AAQA,MAAKH,YAAL,EAAoB;AACnB,UAAMb,MAAM,GAAGa,YAAY,CAACX,WAAb,CAAyBZ,GAAzB,CACd,CAAE;AAAES,MAAAA,UAAU,EAAE;AAAEI,QAAAA,GAAF;AAAOZ,QAAAA,EAAP;AAAWa,QAAAA;AAAX;AAAd,KAAF,MAA0C;AACzCD,MAAAA,GADyC;AAEzCZ,MAAAA,EAAE,EAAEA,EAAE,GAAGC,QAAQ,CAAED,EAAF,EAAM,EAAN,CAAX,GAAwB,IAFW;AAGzCa,MAAAA;AAHyC,KAA1C,CADc,CAAf;AAOA,UAAMhB,GAAG,GAAGY,MAAM,CAACV,GAAP,CAAY,CAAE;AAAEC,MAAAA;AAAF,KAAF,KAAcA,EAA1B,CAAZ;AACAsB,IAAAA,YAAY,CAACd,UAAb,CAAwBC,MAAxB,GAAiCA,MAAjC;AACAa,IAAAA,YAAY,CAACd,UAAb,CAAwBX,GAAxB,GAA8BA,GAA9B;AACA;;AAED,SAAOoB,OAAP;AACA;;AACD5B,SAAS,CACR,2CADQ,EAER,gDAFQ,EAGR2B,oCAHQ,CAAT;AAMA,MAAMU,UAAU,GAAG;AAClBP,EAAAA,IAAI,EAAE,CACL;AACCQ,IAAAA,IAAI,EAAE,OADP;AAECC,IAAAA,YAAY,EAAE,IAFf;AAGCC,IAAAA,MAAM,EAAE,CAAE,YAAF,CAHT;AAICC,IAAAA,SAAS,EAAItB,UAAF,IAAkB;AAC5B;AACA,UAAI;AAAEuB,QAAAA,KAAF;AAASjB,QAAAA;AAAT,UAAsBN,UAAU,CAAE,CAAF,CAApC,CAF4B,CAG5B;;AACAuB,MAAAA,KAAK,GAAGjD,KAAK,CAAE0B,UAAF,EAAc,CAAE,OAAF,EAAWuB,KAAX,CAAd,CAAL,GACLA,KADK,GAELC,SAFH;AAGAlB,MAAAA,QAAQ,GAAGhC,KAAK,CAAE0B,UAAF,EAAc,CAAE,UAAF,EAAcM,QAAd,CAAd,CAAL,GACRA,QADQ,GAERkB,SAFH;AAIA,YAAMC,WAAW,GAAGpD,MAAM,CAAE2B,UAAF,EAAc,CAAE;AAAEI,QAAAA;AAAF,OAAF,KAAeA,GAA7B,CAA1B;AAEA,YAAMR,QAAQ,GAAGlB,MAAM,CAAEE,gBAAF,CAAN,CAA2BiB,WAA3B,EAAjB;;AACA,UAAKD,QAAQ,CAACE,gCAAd,EAAiD;AAChD,cAAMK,WAAW,GAAGsB,WAAW,CAAClC,GAAZ,CAAmBmC,KAAF,IAAa;AACjD,iBAAOlD,WAAW,CAAE,YAAF,EAAgBkD,KAAhB,CAAlB;AACA,SAFmB,CAApB;AAIA,eAAOlD,WAAW,CACjB,cADiB,EAEjB;AACC+C,UAAAA,KADD;AAECjB,UAAAA;AAFD,SAFiB,EAMjBH,WANiB,CAAlB;AAQA;;AAED,aAAO3B,WAAW,CAAE,cAAF,EAAkB;AACnCyB,QAAAA,MAAM,EAAEwB,WAAW,CAAClC,GAAZ,CACP,CAAE;AAAEC,UAAAA,EAAF;AAAMY,UAAAA,GAAN;AAAWC,UAAAA,GAAX;AAAgBsB,UAAAA;AAAhB,SAAF,MAAmC;AAClCnC,UAAAA,EAAE,EAAEjB,QAAQ,CAAEiB,EAAF,CADsB;AAElCY,UAAAA,GAFkC;AAGlCC,UAAAA,GAHkC;AAIlCsB,UAAAA;AAJkC,SAAnC,CADO,CAD2B;AASnCtC,QAAAA,GAAG,EAAEoC,WAAW,CAAClC,GAAZ,CAAiB,CAAE;AAAEC,UAAAA;AAAF,SAAF,KAAcC,QAAQ,CAAED,EAAF,EAAM,EAAN,CAAvC,CAT8B;AAUnC+B,QAAAA,KAVmC;AAWnCjB,QAAAA;AAXmC,OAAlB,CAAlB;AAaA;AA9CF,GADK,EAiDL;AACCa,IAAAA,IAAI,EAAE,WADP;AAECS,IAAAA,GAAG,EAAE,SAFN;AAIC5B,IAAAA,UAAU,EAAE;AACXC,MAAAA,MAAM,EAAE;AACPkB,QAAAA,IAAI,EAAE,OADC;AAEPU,QAAAA,SAAS,EAAE,CAAE;AAAEC,UAAAA,KAAK,EAAE;AAAEzC,YAAAA;AAAF;AAAT,SAAF,KAA0B;AACpC,gBAAMO,QAAQ,GAAGlB,MAAM,CACtBE,gBADsB,CAAN,CAEfiB,WAFe,EAAjB;;AAGA,cAAK,CAAED,QAAQ,CAACE,gCAAhB,EAAmD;AAClD,mBAAOV,iBAAiB,CAAEC,GAAF,CAAjB,CAAyBE,GAAzB,CAAgCC,EAAF,KAAY;AAChDA,cAAAA,EAAE,EAAEjB,QAAQ,CAAEiB,EAAF;AADoC,aAAZ,CAA9B,CAAP;AAGA;AACD;AAXM,OADG;AAcXH,MAAAA,GAAG,EAAE;AACJ8B,QAAAA,IAAI,EAAE,OADF;AAEJU,QAAAA,SAAS,EAAE,CAAE;AAAEC,UAAAA,KAAK,EAAE;AAAEzC,YAAAA;AAAF;AAAT,SAAF,KAA0B;AACpC,gBAAMO,QAAQ,GAAGlB,MAAM,CACtBE,gBADsB,CAAN,CAEfiB,WAFe,EAAjB;;AAGA,cAAK,CAAED,QAAQ,CAACE,gCAAhB,EAAmD;AAClD,mBAAOV,iBAAiB,CAAEC,GAAF,CAAxB;AACA;AACD;AATG,OAdM;AAyBX0C,MAAAA,mBAAmB,EAAE;AACpBZ,QAAAA,IAAI,EAAE,OADc;AAEpBU,QAAAA,SAAS,EAAE,CAAE;AAAEC,UAAAA,KAAK,EAAE;AAAEzC,YAAAA;AAAF;AAAT,SAAF,KAA0B;AACpC,gBAAMO,QAAQ,GAAGlB,MAAM,CACtBE,gBADsB,CAAN,CAEfiB,WAFe,EAAjB;;AAGA,cAAKD,QAAQ,CAACE,gCAAd,EAAiD;AAChD,mBAAOV,iBAAiB,CAAEC,GAAF,CAAjB,CAAyBE,GAAzB,CAAgCC,EAAF,KAAY;AAChDA,cAAAA,EAAE,EAAEC,QAAQ,CAAED,EAAF;AADoC,aAAZ,CAA9B,CAAP;AAGA;AACD;AAXmB,OAzBV;AAsCXwC,MAAAA,OAAO,EAAE;AACRb,QAAAA,IAAI,EAAE,QADE;AAERU,QAAAA,SAAS,EAAE,CAAE;AAAEC,UAAAA,KAAK,EAAE;AAAEE,YAAAA,OAAO,GAAG;AAAZ;AAAT,SAAF,KAAoC;AAC9C,iBAAOvC,QAAQ,CAAEuC,OAAF,EAAW,EAAX,CAAf;AACA;AAJO,OAtCE;AA4CXC,MAAAA,MAAM,EAAE;AACPd,QAAAA,IAAI,EAAE,QADC;AAEPU,QAAAA,SAAS,EAAE,CAAE;AAAEC,UAAAA,KAAK,EAAE;AAAEI,YAAAA;AAAF;AAAT,SAAF,KAA2B;AACrC,gBAAMtC,QAAQ,GAAGlB,MAAM,CACtBE,gBADsB,CAAN,CAEfiB,WAFe,EAAjB;;AAGA,cAAK,CAAED,QAAQ,CAACE,gCAAhB,EAAmD;AAClD,oBAASoC,IAAT;AACC,mBAAK,MAAL;AACC,uBAAOjD,sCAAP;;AACD,mBAAK,MAAL;AACC,uBAAOC,iCAAP;;AACD;AACC,uBAAOD,sCAAP;AANF;AAQA;;AACD,kBAASiD,IAAT;AACC,iBAAK,MAAL;AACC,qBAAOpD,2BAAP;;AACD,iBAAK,MAAL;AACC,qBAAOE,sBAAP;;AACD;AACC,qBAAOD,qBAAP;AANF;AAQA;AAxBM;AA5CG,KAJb;;AA2ECoD,IAAAA,OAAO,CAAE;AAAEL,MAAAA;AAAF,KAAF,EAAc;AACpB,aAAON,SAAS,KAAKM,KAAK,CAACzC,GAA3B;AACA;;AA7EF,GAjDK,EAgIL;AACC;AACA;AACA;AACA;AACA;AACA8B,IAAAA,IAAI,EAAE,OANP;AAOCiB,IAAAA,QAAQ,EAAE,CAPX;;AAQCD,IAAAA,OAAO,CAAEE,KAAF,EAAU;AAChB,aACCA,KAAK,CAACnC,MAAN,KAAiB,CAAjB,IACA5B,KAAK,CACJ+D,KADI,EAEFC,IAAF,IAAYA,IAAI,CAACnB,IAAL,CAAUoB,OAAV,CAAmB,QAAnB,MAAkC,CAF1C,CAFN;AAOA,KAhBF;;AAiBCjB,IAAAA,SAAS,CAAEe,KAAF,EAAU;AAClB,YAAMzC,QAAQ,GAAGlB,MAAM,CAAEE,gBAAF,CAAN,CAA2BiB,WAA3B,EAAjB;;AACA,UAAKD,QAAQ,CAACE,gCAAd,EAAiD;AAChD,cAAMK,WAAW,GAAGkC,KAAK,CAAC9C,GAAN,CAAa+C,IAAF,IAC9B9D,WAAW,CAAE,YAAF,EAAgB;AAC1B4B,UAAAA,GAAG,EAAE3B,aAAa,CAAE6D,IAAF;AADQ,SAAhB,CADQ,CAApB;AAMA,eAAO9D,WAAW,CAAE,cAAF,EAAkB,EAAlB,EAAsB2B,WAAtB,CAAlB;AACA;;AACD,YAAMR,KAAK,GAAGnB,WAAW,CAAE,cAAF,EAAkB;AAC1CyB,QAAAA,MAAM,EAAEoC,KAAK,CAAC9C,GAAN,CAAa+C,IAAF,IAClBnD,sBAAsB,CAAE;AACvBiB,UAAAA,GAAG,EAAE3B,aAAa,CAAE6D,IAAF;AADK,SAAF,CADf;AADkC,OAAlB,CAAzB;AAOA,aAAO3C,KAAP;AACA;;AApCF,GAhIK,CADY;AAwKlB6C,EAAAA,EAAE,EAAE,CACH;AACCrB,IAAAA,IAAI,EAAE,OADP;AAECE,IAAAA,MAAM,EAAE,CAAE,YAAF,CAFT;AAGCC,IAAAA,SAAS,EAAE,CAAE;AAAEC,MAAAA,KAAF;AAAStB,MAAAA,MAAT;AAAiBZ,MAAAA,GAAjB;AAAsBiB,MAAAA;AAAtB,KAAF,EAAoCH,WAApC,KAAqD;AAC/D,YAAMP,QAAQ,GAAGlB,MAAM,CAAEE,gBAAF,CAAN,CAA2BiB,WAA3B,EAAjB;;AACA,UAAKD,QAAQ,CAACE,gCAAd,EAAiD;AAChD,YAAKK,WAAW,CAACD,MAAZ,GAAqB,CAA1B,EAA8B;AAC7B,iBAAOC,WAAW,CAACZ,GAAZ,CACN,CAAE;AACDS,YAAAA,UAAU,EAAE;AACXR,cAAAA,EADW;AAEXY,cAAAA,GAFW;AAGXC,cAAAA,GAHW;AAIXsB,cAAAA,OAJW;AAKXc,cAAAA;AALW;AADX,WAAF,KASCjE,WAAW,CAAE,YAAF,EAAgB;AAC1BgB,YAAAA,EAD0B;AAE1BY,YAAAA,GAF0B;AAG1BC,YAAAA,GAH0B;AAI1BsB,YAAAA,OAJ0B;AAK1BrB,YAAAA,QAAQ,EAAEmC,aALgB;AAM1BlB,YAAAA;AAN0B,WAAhB,CAVN,CAAP;AAmBA;;AACD,eAAO/C,WAAW,CAAE,YAAF,EAAgB;AAAE+C,UAAAA;AAAF,SAAhB,CAAlB;AACA;;AACD,UAAKtB,MAAM,CAACC,MAAP,GAAgB,CAArB,EAAyB;AACxB,eAAOD,MAAM,CAACV,GAAP,CAAY,CAAE;AAAEa,UAAAA,GAAF;AAAOC,UAAAA,GAAP;AAAYsB,UAAAA;AAAZ,SAAF,EAAyBe,KAAzB,KAClBlE,WAAW,CAAE,YAAF,EAAgB;AAC1BgB,UAAAA,EAAE,EAAEH,GAAG,CAAEqD,KAAF,CADmB;AAE1BtC,UAAAA,GAF0B;AAG1BC,UAAAA,GAH0B;AAI1BsB,UAAAA,OAJ0B;AAK1BJ,UAAAA,KAL0B;AAM1BjB,UAAAA;AAN0B,SAAhB,CADL,CAAP;AAUA;;AACD,aAAO9B,WAAW,CAAE,YAAF,EAAgB;AAAE+C,QAAAA;AAAF,OAAhB,CAAlB;AACA;AA1CF,GADG;AAxKc,CAAnB;AAwNA,eAAeL,UAAf","sourcesContent":["/**\n * External dependencies\n */\nimport { filter, every, toString } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { createBlock } from '@wordpress/blocks';\nimport { createBlobURL } from '@wordpress/blob';\nimport { select } from '@wordpress/data';\nimport { store as blockEditorStore } from '@wordpress/block-editor';\nimport { addFilter } from '@wordpress/hooks';\n\n/**\n * Internal dependencies\n */\nimport {\n\tLINK_DESTINATION_ATTACHMENT,\n\tLINK_DESTINATION_NONE,\n\tLINK_DESTINATION_MEDIA,\n} from './constants';\nimport {\n\tLINK_DESTINATION_ATTACHMENT as DEPRECATED_LINK_DESTINATION_ATTACHMENT,\n\tLINK_DESTINATION_MEDIA as DEPRECATED_LINK_DESTINATION_MEDIA,\n} from './v1/constants';\nimport { pickRelevantMediaFiles } from './shared';\n\nconst parseShortcodeIds = ( ids ) => {\n\tif ( ! ids ) {\n\t\treturn [];\n\t}\n\n\treturn ids.split( ',' ).map( ( id ) => parseInt( id, 10 ) );\n};\n\n/**\n * Third party block plugins don't have an easy way to detect if the\n * innerBlocks version of the Gallery is running when they run a\n * 3rdPartyBlock -> GalleryBlock transform so this tranform filter\n * will handle this. Once the innerBlocks version is the default\n * in a core release, this could be deprecated and removed after\n * plugin authors have been given time to update transforms.\n *\n * @typedef  {Object} Attributes\n * @typedef  {Object} Block\n * @property {Attributes} attributes The attributes of the block.\n * @param    {Block}      block      The transformed block.\n * @return   {Block}                 The transformed block.\n */\nfunction updateThirdPartyTransformToGallery( block ) {\n\tconst settings = select( blockEditorStore ).getSettings();\n\tif (\n\t\tsettings.__unstableGalleryWithImageBlocks &&\n\t\tblock.name === 'core/gallery' &&\n\t\tblock.attributes?.images.length > 0\n\t) {\n\t\tconst innerBlocks = block.attributes.images.map(\n\t\t\t( { url, id, alt } ) => {\n\t\t\t\treturn createBlock( 'core/image', {\n\t\t\t\t\turl,\n\t\t\t\t\tid: id ? parseInt( id, 10 ) : null,\n\t\t\t\t\talt,\n\t\t\t\t\tsizeSlug: block.attributes.sizeSlug,\n\t\t\t\t\tlinkDestination: block.attributes.linkDestination,\n\t\t\t\t} );\n\t\t\t}\n\t\t);\n\n\t\tdelete block.attributes.ids;\n\t\tdelete block.attributes.images;\n\t\tblock.innerBlocks = innerBlocks;\n\t}\n\n\treturn block;\n}\naddFilter(\n\t'blocks.switchToBlockType.transformedBlock',\n\t'core/gallery/update-third-party-transform-to',\n\tupdateThirdPartyTransformToGallery\n);\n\n/**\n * Third party block plugins don't have an easy way to detect if the\n * innerBlocks version of the Gallery is running when they run a\n * GalleryBlock -> 3rdPartyBlock transform so this transform filter\n * will handle this. Once the innerBlocks version is the default\n * in a core release, this could be deprecated and removed after\n * plugin authors have been given time to update transforms.\n *\n * @typedef  {Object} Attributes\n * @typedef  {Object} Block\n * @property {Attributes} attributes The attributes of the block.\n * @param    {Block}      toBlock    The block to transform to.\n * @param    {Block[]}    fromBlocks The blocks to transform from.\n * @return   {Block}                 The transformed block.\n */\nfunction updateThirdPartyTransformFromGallery( toBlock, fromBlocks ) {\n\tconst from = Array.isArray( fromBlocks ) ? fromBlocks : [ fromBlocks ];\n\tconst galleryBlock = from.find(\n\t\t( transformedBlock ) =>\n\t\t\ttransformedBlock.name === 'core/gallery' &&\n\t\t\ttransformedBlock.innerBlocks.length > 0 &&\n\t\t\t! transformedBlock.attributes.images?.length > 0 &&\n\t\t\t! toBlock.name.includes( 'core/' )\n\t);\n\n\tif ( galleryBlock ) {\n\t\tconst images = galleryBlock.innerBlocks.map(\n\t\t\t( { attributes: { url, id, alt } } ) => ( {\n\t\t\t\turl,\n\t\t\t\tid: id ? parseInt( id, 10 ) : null,\n\t\t\t\talt,\n\t\t\t} )\n\t\t);\n\t\tconst ids = images.map( ( { id } ) => id );\n\t\tgalleryBlock.attributes.images = images;\n\t\tgalleryBlock.attributes.ids = ids;\n\t}\n\n\treturn toBlock;\n}\naddFilter(\n\t'blocks.switchToBlockType.transformedBlock',\n\t'core/gallery/update-third-party-transform-from',\n\tupdateThirdPartyTransformFromGallery\n);\n\nconst transforms = {\n\tfrom: [\n\t\t{\n\t\t\ttype: 'block',\n\t\t\tisMultiBlock: true,\n\t\t\tblocks: [ 'core/image' ],\n\t\t\ttransform: ( attributes ) => {\n\t\t\t\t// Init the align and size from the first item which may be either the placeholder or an image.\n\t\t\t\tlet { align, sizeSlug } = attributes[ 0 ];\n\t\t\t\t// Loop through all the images and check if they have the same align and size.\n\t\t\t\talign = every( attributes, [ 'align', align ] )\n\t\t\t\t\t? align\n\t\t\t\t\t: undefined;\n\t\t\t\tsizeSlug = every( attributes, [ 'sizeSlug', sizeSlug ] )\n\t\t\t\t\t? sizeSlug\n\t\t\t\t\t: undefined;\n\n\t\t\t\tconst validImages = filter( attributes, ( { url } ) => url );\n\n\t\t\t\tconst settings = select( blockEditorStore ).getSettings();\n\t\t\t\tif ( settings.__unstableGalleryWithImageBlocks ) {\n\t\t\t\t\tconst innerBlocks = validImages.map( ( image ) => {\n\t\t\t\t\t\treturn createBlock( 'core/image', image );\n\t\t\t\t\t} );\n\n\t\t\t\t\treturn createBlock(\n\t\t\t\t\t\t'core/gallery',\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\talign,\n\t\t\t\t\t\t\tsizeSlug,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tinnerBlocks\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\treturn createBlock( 'core/gallery', {\n\t\t\t\t\timages: validImages.map(\n\t\t\t\t\t\t( { id, url, alt, caption } ) => ( {\n\t\t\t\t\t\t\tid: toString( id ),\n\t\t\t\t\t\t\turl,\n\t\t\t\t\t\t\talt,\n\t\t\t\t\t\t\tcaption,\n\t\t\t\t\t\t} )\n\t\t\t\t\t),\n\t\t\t\t\tids: validImages.map( ( { id } ) => parseInt( id, 10 ) ),\n\t\t\t\t\talign,\n\t\t\t\t\tsizeSlug,\n\t\t\t\t} );\n\t\t\t},\n\t\t},\n\t\t{\n\t\t\ttype: 'shortcode',\n\t\t\ttag: 'gallery',\n\n\t\t\tattributes: {\n\t\t\t\timages: {\n\t\t\t\t\ttype: 'array',\n\t\t\t\t\tshortcode: ( { named: { ids } } ) => {\n\t\t\t\t\t\tconst settings = select(\n\t\t\t\t\t\t\tblockEditorStore\n\t\t\t\t\t\t).getSettings();\n\t\t\t\t\t\tif ( ! settings.__unstableGalleryWithImageBlocks ) {\n\t\t\t\t\t\t\treturn parseShortcodeIds( ids ).map( ( id ) => ( {\n\t\t\t\t\t\t\t\tid: toString( id ),\n\t\t\t\t\t\t\t} ) );\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tids: {\n\t\t\t\t\ttype: 'array',\n\t\t\t\t\tshortcode: ( { named: { ids } } ) => {\n\t\t\t\t\t\tconst settings = select(\n\t\t\t\t\t\t\tblockEditorStore\n\t\t\t\t\t\t).getSettings();\n\t\t\t\t\t\tif ( ! settings.__unstableGalleryWithImageBlocks ) {\n\t\t\t\t\t\t\treturn parseShortcodeIds( ids );\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tshortCodeTransforms: {\n\t\t\t\t\ttype: 'array',\n\t\t\t\t\tshortcode: ( { named: { ids } } ) => {\n\t\t\t\t\t\tconst settings = select(\n\t\t\t\t\t\t\tblockEditorStore\n\t\t\t\t\t\t).getSettings();\n\t\t\t\t\t\tif ( settings.__unstableGalleryWithImageBlocks ) {\n\t\t\t\t\t\t\treturn parseShortcodeIds( ids ).map( ( id ) => ( {\n\t\t\t\t\t\t\t\tid: parseInt( id ),\n\t\t\t\t\t\t\t} ) );\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tcolumns: {\n\t\t\t\t\ttype: 'number',\n\t\t\t\t\tshortcode: ( { named: { columns = '3' } } ) => {\n\t\t\t\t\t\treturn parseInt( columns, 10 );\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tlinkTo: {\n\t\t\t\t\ttype: 'string',\n\t\t\t\t\tshortcode: ( { named: { link } } ) => {\n\t\t\t\t\t\tconst settings = select(\n\t\t\t\t\t\t\tblockEditorStore\n\t\t\t\t\t\t).getSettings();\n\t\t\t\t\t\tif ( ! settings.__unstableGalleryWithImageBlocks ) {\n\t\t\t\t\t\t\tswitch ( link ) {\n\t\t\t\t\t\t\t\tcase 'post':\n\t\t\t\t\t\t\t\t\treturn DEPRECATED_LINK_DESTINATION_ATTACHMENT;\n\t\t\t\t\t\t\t\tcase 'file':\n\t\t\t\t\t\t\t\t\treturn DEPRECATED_LINK_DESTINATION_MEDIA;\n\t\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\t\treturn DEPRECATED_LINK_DESTINATION_ATTACHMENT;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tswitch ( link ) {\n\t\t\t\t\t\t\tcase 'post':\n\t\t\t\t\t\t\t\treturn LINK_DESTINATION_ATTACHMENT;\n\t\t\t\t\t\t\tcase 'file':\n\t\t\t\t\t\t\t\treturn LINK_DESTINATION_MEDIA;\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\treturn LINK_DESTINATION_NONE;\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\tisMatch( { named } ) {\n\t\t\t\treturn undefined !== named.ids;\n\t\t\t},\n\t\t},\n\t\t{\n\t\t\t// When created by drag and dropping multiple files on an insertion point. Because multiple\n\t\t\t// files must not be transformed to a gallery when dropped within a gallery there is another transform\n\t\t\t// within the image block to handle that case. Therefore this transform has to have priority 1\n\t\t\t// set so that it overrrides the image block transformation when mulitple images are dropped outside\n\t\t\t// of a gallery block.\n\t\t\ttype: 'files',\n\t\t\tpriority: 1,\n\t\t\tisMatch( files ) {\n\t\t\t\treturn (\n\t\t\t\t\tfiles.length !== 1 &&\n\t\t\t\t\tevery(\n\t\t\t\t\t\tfiles,\n\t\t\t\t\t\t( file ) => file.type.indexOf( 'image/' ) === 0\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t},\n\t\t\ttransform( files ) {\n\t\t\t\tconst settings = select( blockEditorStore ).getSettings();\n\t\t\t\tif ( settings.__unstableGalleryWithImageBlocks ) {\n\t\t\t\t\tconst innerBlocks = files.map( ( file ) =>\n\t\t\t\t\t\tcreateBlock( 'core/image', {\n\t\t\t\t\t\t\turl: createBlobURL( file ),\n\t\t\t\t\t\t} )\n\t\t\t\t\t);\n\n\t\t\t\t\treturn createBlock( 'core/gallery', {}, innerBlocks );\n\t\t\t\t}\n\t\t\t\tconst block = createBlock( 'core/gallery', {\n\t\t\t\t\timages: files.map( ( file ) =>\n\t\t\t\t\t\tpickRelevantMediaFiles( {\n\t\t\t\t\t\t\turl: createBlobURL( file ),\n\t\t\t\t\t\t} )\n\t\t\t\t\t),\n\t\t\t\t} );\n\t\t\t\treturn block;\n\t\t\t},\n\t\t},\n\t],\n\tto: [\n\t\t{\n\t\t\ttype: 'block',\n\t\t\tblocks: [ 'core/image' ],\n\t\t\ttransform: ( { align, images, ids, sizeSlug }, innerBlocks ) => {\n\t\t\t\tconst settings = select( blockEditorStore ).getSettings();\n\t\t\t\tif ( settings.__unstableGalleryWithImageBlocks ) {\n\t\t\t\t\tif ( innerBlocks.length > 0 ) {\n\t\t\t\t\t\treturn innerBlocks.map(\n\t\t\t\t\t\t\t( {\n\t\t\t\t\t\t\t\tattributes: {\n\t\t\t\t\t\t\t\t\tid,\n\t\t\t\t\t\t\t\t\turl,\n\t\t\t\t\t\t\t\t\talt,\n\t\t\t\t\t\t\t\t\tcaption,\n\t\t\t\t\t\t\t\t\timageSizeSlug,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t} ) =>\n\t\t\t\t\t\t\t\tcreateBlock( 'core/image', {\n\t\t\t\t\t\t\t\t\tid,\n\t\t\t\t\t\t\t\t\turl,\n\t\t\t\t\t\t\t\t\talt,\n\t\t\t\t\t\t\t\t\tcaption,\n\t\t\t\t\t\t\t\t\tsizeSlug: imageSizeSlug,\n\t\t\t\t\t\t\t\t\talign,\n\t\t\t\t\t\t\t\t} )\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\treturn createBlock( 'core/image', { align } );\n\t\t\t\t}\n\t\t\t\tif ( images.length > 0 ) {\n\t\t\t\t\treturn images.map( ( { url, alt, caption }, index ) =>\n\t\t\t\t\t\tcreateBlock( 'core/image', {\n\t\t\t\t\t\t\tid: ids[ index ],\n\t\t\t\t\t\t\turl,\n\t\t\t\t\t\t\talt,\n\t\t\t\t\t\t\tcaption,\n\t\t\t\t\t\t\talign,\n\t\t\t\t\t\t\tsizeSlug,\n\t\t\t\t\t\t} )\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\treturn createBlock( 'core/image', { align } );\n\t\t\t},\n\t\t},\n\t],\n};\n\nexport default transforms;\n"]}